-- Rename a workflow setting attribute
UPDATE [Attribute] SET
    [Name] = 'Use Same Options',
    [Key] = 'core_checkin_UseSameOptions'
WHERE [Guid] = 'EC7FA927-95D0-44A8-8AB3-2D74A9FA2F26'

-- Fix the ordering of the Person Search workflow activity
DECLARE @ActivityTypeId int = ( SELECT TOP 1 [Id] FROM [WorkflowActivityType] WHERE [Guid] = 'EB744DF1-E454-482C-B111-80A54EF8A674' )

DECLARE @EntityTypeId int = ( SELECT TOP 1 [Id] FROM [EntityType] WHERE [Name] = 'Rock.Workflow.Action.CheckIn.LoadLocations' )
DECLARE @Order int = ISNULL( ( SELECT TOP 1 [Order] FROM [WorkflowActionType] WHERE [ActivityTypeId] = @ActivityTypeId AND [EntityTypeId] = @EntityTypeId ), 0)
UPDATE [WorkflowActionType] SET [Order] = [Order] + 1 WHERE [ActivityTypeId] = @ActivityTypeId AND [Order] > @Order
UPDATE [WorkflowActionType] SET [Order] = @Order + 1 WHERE [Guid] = '6A4E09F0-7AAF-441A-AAD7-BFEA7AF08A6A'

SET @EntityTypeId = ( SELECT TOP 1 [Id] FROM [EntityType] WHERE [Name] = 'Rock.Workflow.Action.CheckIn.RemoveEmptyPeople' )
SET @Order = ISNULL( ( SELECT TOP 1 [Order] FROM [WorkflowActionType] WHERE [ActivityTypeId] = @ActivityTypeId AND [EntityTypeId] = @EntityTypeId ), 0)
UPDATE [WorkflowActionType] SET [Order] = [Order] + 1 WHERE [ActivityTypeId] = @ActivityTypeId AND [Order] > @Order
UPDATE [WorkflowActionType] SET [Order] = @Order + 1 WHERE [Guid] = '79CB608D-ED25-4526-A0F5-132D13642CDA'

SET @EntityTypeId = ( SELECT TOP 1 [Id] FROM [EntityType] WHERE [Name] = 'Rock.Workflow.Action.CheckIn.CalculateLastAttended' )
SET @Order = ISNULL( ( SELECT TOP 1 [Order] FROM [WorkflowActionType] WHERE [ActivityTypeId] = @ActivityTypeId AND [EntityTypeId] = @EntityTypeId ), 0)
UPDATE [WorkflowActionType] SET [Order] = [Order] + 1 WHERE [ActivityTypeId] = @ActivityTypeId AND [Order] > @Order
UPDATE [WorkflowActionType] SET [Order] = @Order + 1 WHERE [Guid] = '08D15C7A-4421-420A-BCA8-D6EE532E659F'

-- Fix the ordering of the Ability Level Search workflow activity
UPDATE [WorkflowActionType]
SET [Order] = ISNULL(
	(
		SELECT MAX(A.[Order]) + 1
		FROM [WorkflowActivityType] T 
		INNER JOIN [WorkflowActionType] A ON A.[ActivityTypeId] = T.[Id]
		WHERE T.[Guid] = '0E2F5EBA-2204-4C2F-845A-92C25AB67474'
		AND A.[Guid] <> '902931D2-6326-4A6A-967C-C9F65F8C1386'
	),0)
WHERE [Guid] = '902931D2-6326-4A6A-967C-C9F65F8C1386'

-- Update Check-in Labels
DECLARE @BinaryFileTypeId int = ( SELECT TOP 1 [Id] FROM [BinaryFileType] WHERE [Guid] = 'DE0E5C50-234B-474C-940C-C571F385E65F' )
DECLARE @StorageEntityTypeId int = ( SELECT TOP 1 [StorageEntityTypeId] FROM [BinaryFileType] WHERE [Id] = @BinaryFileTypeId )
DECLARE @MergeCodesAttributeId int = ( SELECT TOP 1 [Id] FROM [Attribute] WHERE [Guid] = 'CE57450F-634A-420A-BF5A-B43E9B20ABF2' )
DECLARE @LabelTypeAttributeId int = ( SELECT TOP 1 [Id] FROM [Attribute] WHERE [Guid] = '733944B7-A0D5-41B4-94D4-DE007F72B6F0' )

DECLARE @SecurityCodeValueId INT = (SELECT TOP 1 [Id] FROM [DefinedValue] WHERE [Guid] = '9DCB69C4-1B9B-4D31-B8B6-8C9DBFA9933B') 
DECLARE @NickNameValueId INT = (SELECT TOP 1 [Id] FROM [DefinedValue] WHERE [Guid] = 'E2DB40F4-A064-429E-9A76-C520E7E7A43A') 
DECLARE @LastNameValueId INT = (SELECT TOP 1 [Id] FROM [DefinedValue] WHERE [Guid] = '85B71255-19F9-4443-A7AE-EF670385DC71') 
DECLARE @BirthdayIconValueId INT = (SELECT TOP 1 [Id] FROM [DefinedValue] WHERE [Guid] = 'C6AA76B5-3E7F-4E14-905E-36173E60949D') 
DECLARE @ScheduleTimesValueId INT = (SELECT TOP 1 [Id] FROM [DefinedValue] WHERE [Guid] = '18B24BF8-26DD-43BB-A54D-8B10C57EA740') 
DECLARE @FullNameValueId INT = (SELECT TOP 1 [Id] FROM [DefinedValue] WHERE [Guid] = '0CDCE2CD-DA27-4BB8-A799-DB780674B00E') 
DECLARE @LocationsValueId INT = (SELECT TOP 1 [Id] FROM [DefinedValue] WHERE [Guid] = '13E9155C-B153-454B-B3B4-6687767C9400') 
DECLARE @BirthdayDayofWeekValueId INT = (SELECT TOP 1 [Id] FROM [DefinedValue] WHERE [Guid] = '604CB370-636B-43D2-9674-B7CE8A09EAFA') 
DECLARE @LegalIconValueId INT = (SELECT TOP 1 [Id] FROM [DefinedValue] WHERE [Guid] = 'BD31D356-0B9F-453C-A9DD-E066DB2DAB3C') 
DECLARE @LegalNoteValueId INT = (SELECT TOP 1 [Id] FROM [DefinedValue] WHERE [Guid] = '94CC0022-D324-4492-81A3-30E1BEB1C85A') 
DECLARE @AllergyIconValueId INT = (SELECT TOP 1 [Id] FROM [DefinedValue] WHERE [Guid] = 'CD131071-28B1-440D-AFC6-AAA998B59BF9') 
DECLARE @AllergyNoteValueId INT = (SELECT TOP 1 [Id] FROM [DefinedValue] WHERE [Guid] = 'A1E7ECBD-6248-42BA-8844-2378EA2B9F0E') 
DECLARE @FirsttimeIconValueId INT = (SELECT TOP 1 [Id] FROM [DefinedValue] WHERE [Guid] = 'BD1B1FEA-D4A9-45EB-9958-01EF75D5A949') 
DECLARE @CurrentDayDateValueId INT = (SELECT TOP 1 [Id] FROM [DefinedValue] WHERE [Guid] = '23502286-D921-4455-BABC-D8D6CB8FFB3D')
DECLARE @CodeAgesOddValueId INT = (SELECT TOP 1 [Id] FROM [DefinedValue] WHERE [Guid] = '170207B6-9218-4E6E-8ADA-661521E80E5E')
DECLARE @CodeAgesEvenValueId INT = (SELECT TOP 1 [Id] FROM [DefinedValue] WHERE [Guid] = '5B11A934-0398-429F-9A91-F727153392E7')
DECLARE @NameCodeOddValueId INT = (SELECT TOP 1 [Id] FROM [DefinedValue] WHERE [Guid] = '1FAA4DAC-5240-486E-A23F-2A47D7F36F31')
DECLARE @NameCodeEvenValueId INT = (SELECT TOP 1 [Id] FROM [DefinedValue] WHERE [Guid] = '3DCF76E8-866C-4EC9-B1FB-552691A8B440')
DECLARE @PersonLocTimesValueId INT = (SELECT TOP 1 [Id] FROM [DefinedValue] WHERE [Guid] = '08882D9E-4D49-4D1E-94D2-7E5CF64A570D')
DECLARE @LocTimesValueId INT = (SELECT TOP 1 [Id] FROM [DefinedValue] WHERE [Guid] = 'B407E2A5-A7DC-4C29-9B41-B88C99838BD1')

UPDATE [Attribute] SET [EntityTypeQualifierValue] = CAST( @BinaryFileTypeId AS VARCHAR ) WHERE [Guid] = '733944B7-A0D5-41B4-94D4-DE007F72B6F0'

DECLARE @LabelFileId int

-- Parent Label
SET @LabelFileId = ( SELECT TOP 1 [Id] FROM [BinaryFile] WHERE [Guid] = '9B098DB0-952C-43FB-A5BD-511E3C2B72FB' )

UPDATE [BinaryFileData] 
SET [Content] = 0xEFBBBF1043547E7E43442C7E43435E7E43547E0D0A5E58417E54413030307E4A534E5E4C54305E4D4E575E4D54445E504F4E5E504D4E5E4C48302C305E4A4D415E5052362C367E534431355E4A55535E4C524E5E4349305E585A0D0A5E58410D0A5E4D4D540D0A5E50573831320D0A5E4C4C303430360D0A5E4C53300D0A5E465432302C38305E41304E2C37332C37325E46423830302C302C302C4C5E46485C5E46444368696C64205069636B757020526563656970745E46530D0A5E46423230302C372C302C4C5E465433302C3339305E41304E2C33392C33385E4644315E46530D0A5E46423230302C372C302C4C5E46543431352C3339305E41304E2C33392C33385E4644325E46530D0A5E465431342C3336395E41304E2C32332C32345E46485C5E4644466F722074686520736166657479206F6620796F7572206368696C642C20796F75206D7573742070726573656E7420746869732072656365697074207768656E207069636B696E675E46530D0A5E465431352C3339335E41304E2C32332C32345E46485C5E4644757020796F7572206368696C642E20496620796F75206C6F7365207468697320706C6561736520736565207468652061726561206469726563746F722E5E46530D0A5E4C52595E464F302C305E47423831322C302C3130305E46535E4C524E0D0A5E5051312C302C312C595E585A
WHERE [Id] = @LabelFileId

UPDATE [AttributeValue] 
SET [Value] = N'1^' + CAST(@NameCodeOddValueId AS VARCHAR)
	+ '|2^' + CAST(@NameCodeEvenValueId AS VARCHAR)
	+ '|'
WHERE [AttributeId] = @MergeCodesAttributeId
AND [EntityId] = @LabelFileId

INSERT INTO [AttributeValue] 
	    ([IsSystem] 
	    ,[AttributeId] 
	    ,[EntityId] 
	    ,[Value] 
	    ,[Guid]) 
    VALUES
	    (0 
	    ,@LabelTypeAttributeId
	    ,@LabelFileId 
		,N'0'
		,'8F6B7705-90A0-4954-95D9-3A54B44785CC' )

-- Child Label (Text)
SET @LabelFileId = ( SELECT TOP 1 [Id] FROM [BinaryFile] WHERE [Guid] = '1B31A2A3-6438-4557-8788-7F057A025EAA' )

UPDATE [BinaryFileData] 
SET [Content] =	0xEFBBBF1043547E7E43442C7E43435E7E43547E0D0A5E58417E54413030307E4A534E5E4C54305E4D4E575E4D54445E504F4E5E504D4E5E4C48302C305E4A4D415E5052362C367E534431355E4A55535E4C524E5E4349305E585A0D0A5E58410D0A5E4D4D540D0A5E50573831320D0A5E4C4C303430360D0A5E4C53300D0A5E46543434332C3131395E41304E2C3133352C3133345E46423333332C312C302C525E46485C5E46445757575E46530D0A5E4654352C3234385E41304E2C3133352C3134365E46485C5E4644355E46530D0A5E4654342C3330335E41304E2C34352C34355E46485C5E4644365E46530D0A5E464F3632362C3334305E474237382C35362C35365E46530D0A5E46543632362C3338345E41304E2C34352C34355E464237382C312C302C435E46525E46485C5E46444141415E46530D0A5E464F3731392C3334305E474236362C35362C35365E46530D0A5E46543731392C3338345E41304E2C34352C34355E464236362C312C302C435E46525E46485C5E46444C4C4C5E46530D0A5E46543333362C3130335E41304E2C3130322C3130305E46485C5E4644325E46530D0A5E46543430312C3130335E41304E2C3130322C3130305E46485C5E4644335E46530D0A5E46543334322C3133305E41304E2C32382C32385E46485C5E4644345E46530D0A5E46423333302C322C302C4C5E4654382C3338325E41304E2C32382C32385E46485C5E4644395E46530D0A5E4C52595E464F302C305E47423831322C302C3133365E46535E4C524E0D0A5E5051312C302C312C595E585A0D0A
WHERE [Id] = @LabelFileId

UPDATE [AttributeValue] 
SET [Value] = N'WWW^' + CAST(@SecurityCodeValueId AS VARCHAR)
		+ '|5^' + CAST(@NickNameValueId AS VARCHAR)
		+ '|6^' + CAST(@LastNameValueId AS VARCHAR)
		+ '|AAA^' + CAST(@AllergyIconValueId AS VARCHAR)
		+ '|LLL^' + CAST(@LegalIconValueId AS VARCHAR)
		+ '|2^' + CAST(@BirthdayIconValueId AS VARCHAR)
		+ '|3^' + CAST(@FirsttimeIconValueId AS VARCHAR)
		+ '|4^' + CAST(@BirthdayDayofWeekValueId AS VARCHAR)
		+ '|9^' + CAST(@PersonLocTimesValueId AS VARCHAR)
		+ '|'
WHERE [AttributeId] = @MergeCodesAttributeId
AND [EntityId] = @LabelFileId

INSERT INTO [AttributeValue] 
	    ([IsSystem] 
	    ,[AttributeId] 
	    ,[EntityId] 
	    ,[Value] 
	    ,[Guid]) 
    VALUES
	    (0 
	    ,@LabelTypeAttributeId
	    ,@LabelFileId 
		,N'1'
		,'FCB20744-4E04-42DD-8CE2-88503636A49D' )

-- Child Label (Icon)
SET @LabelFileId = ( SELECT TOP 1 [Id] FROM [BinaryFile] WHERE [Guid] = 'C2E6B0A0-3991-4FAF-9E2F-49CF321CBB0D' )

UPDATE [BinaryFileData] 
SET [Content] =	0xEFBBBF1043547E7E43442C7E43435E7E43547E0D0A5E58417E54413030307E4A534E5E4C54305E4D4E575E4D54445E504F4E5E504D4E5E4C48302C305E4A4D415E5052362C367E534432345E4A55535E4C524E5E4349305E585A0D0A5E58410D0A5E4D4D540D0A5E50573831320D0A5E4C4C303430360D0A5E4C53300D0A5E46543435322C3131395E41304E2C3133352C3133345E46423333332C312C302C525E46485C5E46445757575E46530D0A5E465431322C3235345E41304E2C3133352C3134365E46485C5E4644355E46530D0A5E465431342C3330395E41304E2C34352C34355E46485C5E4644365E46530D0A5E43575A2C453A524F433030302E464E545E46543239332C38325E415A4E2C37332C36340D0A5E46485C5E4644425E46530D0A5E43575A2C453A524F433030302E464E545E46543337382C38315E415A4E2C37332C36340D0A5E46485C5E4644465E46530D0A5E46543239392C3132305E41304E2C32382C32385E46485C5E4644345E46530D0A5E46423333302C322C302C4C5E4654382C3338325E41304E2C32382C32385E46485C5E4644395E46530D0A5E43575A2C453A524F433030302E464E545E46543630352C3338335E415A4E2C37332C36340D0A5E46485C5E4644375E46530D0A5E43575A2C453A524F433030302E464E545E46543731352C3338365E415A4E2C37332C36340D0A5E46485C5E4644385E46530D0A5E4C52595E464F302C305E47423831322C302C3133365E46535E4C524E0D0A5E5051312C302C312C595E585A0D0A
WHERE [Id] = @LabelFileId

UPDATE [AttributeValue] 
SET [Value] = N'WWW^' + CAST(@SecurityCodeValueId AS VARCHAR)
		+ '|5^' + CAST(@NickNameValueId AS VARCHAR)
		+ '|6^' + CAST(@LastNameValueId AS VARCHAR)
		+ '|B^' + CAST(@BirthdayIconValueId AS VARCHAR)
		+ '|F^' + CAST(@FirsttimeIconValueId AS VARCHAR)
		+ '|4^' + CAST(@BirthdayDayofWeekValueId AS VARCHAR)
		+ '|9^' + CAST(@PersonLocTimesValueId AS VARCHAR)
		+ '|7^' + CAST(@AllergyIconValueId AS VARCHAR)
		+ '|8^' + CAST(@LegalIconValueId AS VARCHAR)
		+ '|'
WHERE [AttributeId] = @MergeCodesAttributeId
AND [EntityId] = @LabelFileId

INSERT INTO [AttributeValue] 
	    ([IsSystem] 
	    ,[AttributeId] 
	    ,[EntityId] 
	    ,[Value] 
	    ,[Guid]) 
    VALUES
	    (0 
	    ,@LabelTypeAttributeId
	    ,@LabelFileId 
		,N'1'
		,'404E7922-F0CE-4889-A509-A46A07C9D731' )

-- Note Label
SET @LabelFileId = ( SELECT TOP 1 [Id] FROM [BinaryFile] WHERE [Guid] = '50E743E2-76C1-428F-8072-E9BC157D0A08' )

UPDATE [BinaryFileData] 
SET [Content] =	0xEFBBBF1043547E7E43442C7E43435E7E43547E0D0A5E58417E54413030307E4A534E5E4C54305E4D4E575E4D54445E504F4E5E504D4E5E4C48302C305E4A4D415E5052362C367E534431355E4A55535E4C524E5E4349305E585A0D0A5E58410D0A5E4D4D540D0A5E50573831320D0A5E4C4C303430360D0A5E4C53300D0A5E46543630372C36385E41304E2C37332C37325E46423137372C312C302C525E46485C5E46445757575E46530D0A5E4654362C3132325E41304E2C33392C33385E46485C5E4644325E46530D0A5E464F382C3136315E474235372C34322C34325E46530D0A5E4654382C3139345E41304E2C33342C33335E464235372C312C302C435E46525E46485C5E46444141415E46530D0A5E46423333302C332C302C4C5E46543432372C3136385E41304E2C32352C32345E46485C5E4644335E46530D0A5E464F31322C3236345E474234382C34322C34325E46530D0A5E465431322C3239375E41304E2C33342C33335E464234382C312C302C435E46525E46485C5E46444C4C4C5E46530D0A5E46423333302C342C302C4C5E465436382C3235305E41304E2C32332C32345E46485C5E4644355E46530D0A5E46423333302C342C302C4C5E465436382C3335345E41304E2C32332C32345E46485C5E4644375E46530D0A5E46543432312C3231325E41304E2C32332C32345E46485C5E46444E6F7465733A5E46530D0A5E464F3430332C3135345E4742302C3233372C315E46530D0A5E464F3432322C3338365E47423336312C302C315E46530D0A5E464F3432332C3334355E47423336312C302C315E46530D0A5E464F3432312C3330345E47423336312C302C315E46530D0A5E464F3432312C3236335E47423336312C302C315E46530D0A5E4C52595E464F302C305E47423831322C302C38315E46535E4C524E0D0A5E5051312C302C312C595E585A0D0A
WHERE [Id] = @LabelFileId

UPDATE [AttributeValue] 
SET [Value] = N'WWW^' + CAST(@SecurityCodeValueId AS VARCHAR)
		+ '|2^' + CAST(@FullNameValueId AS VARCHAR)
		+ '|AAA^' + CAST(@AllergyIconValueId AS VARCHAR)
		+ '|3^' + CAST(@LocTimesValueId AS VARCHAR)
		+ '|LLL^' + CAST(@LegalIconValueId AS VARCHAR)
		+ '|5^' + CAST(@AllergyNoteValueId AS VARCHAR)
		+ '|7^' + CAST(@LegalNoteValueId AS VARCHAR)
		+ '|'
WHERE [AttributeId] = @MergeCodesAttributeId
AND [EntityId] = @LabelFileId

INSERT INTO [AttributeValue] 
	    ([IsSystem] 
	    ,[AttributeId] 
	    ,[EntityId] 
	    ,[Value] 
	    ,[Guid]) 
    VALUES
	    (0 
	    ,@LabelTypeAttributeId
	    ,@LabelFileId 
		,N'2'
		,'BE825EE8-C148-475B-9A5F-BD828237F60D' )

-- Set correct defaults for Check-in Type and Phone Search Type attributes
UPDATE [Attribute] SET [DefaultValue] = '1' WHERE GUID IN ( '90C34D24-7CFB-4A52-B39C-DFF05A40997C', '34D0971A-53AB-4D43-94EA-E251081D7F93' )

-- Update new installs to default to Family check-in
DECLARE @AttendanceRecords int = ( SELECT COUNT(*) FROM [Attendance] )
IF @AttendanceRecords IS NULL OR @AttendanceRecords <= 0
BEGIN

	DECLARE @GroupTypeId int = ( SELECT TOP 1 [Id] FROM [GroupType] WHERE [Guid] = 'FEDD389A-616F-4A53-906C-63D8255631C5' )

	DECLARE @AttributeId int = ( SELECT TOP 1 [Id] FROM [Attribute] WHERE [Guid] = '90C34D24-7CFB-4A52-B39C-DFF05A40997C' )
	UPDATE [AttributeValue] SET [Value] = '1' WHERE [AttributeId] = @AttributeId AND [EntityId] = @GroupTypeId 

	SET @AttributeId = ( SELECT TOP 1 [Id] FROM [Attribute] WHERE [Guid] = 'EC7FA927-95D0-44A8-8AB3-2D74A9FA2F26' )
	UPDATE [AttributeValue] SET [Value] = 'True' WHERE [AttributeId] = @AttributeId AND [EntityId] = @GroupTypeId 

END